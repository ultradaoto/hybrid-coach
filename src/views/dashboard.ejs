<section>
  <style>
    .appointment-item {
      margin-bottom: 1rem;
      padding: 1rem;
      background: #f5f5f5;
      border-radius: 8px;
      border-left: 4px solid #28a745;
    }
    .appointment-item.coach {
      border-left-color: #007bff;
    }
  </style>
  
  <h2>Welcome, <%= user.displayName %></h2>
  <p>Your email: <%= user.email ?? 'N/A' %></p>
  
  <% if (message) { %>
    <div style="background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem;">
      <%= message %>
    </div>
  <% } %>

  <!-- Include membership warning component -->
  <%- include('partials/membership-warning') %>

  <% if (user.role === 'coach') { %>
    <!-- Auto-refresh for coaches every 10 seconds -->
    <script>
      setTimeout(() => {
        window.location.reload();
      }, 10000);
    </script>
    
    <h3>Coach Tools</h3>
    
    <!-- Coach Availability Toggle -->
    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
      <div style="display: flex; align-items: center; justify-content: space-between;">
        <div>
          <strong>ğŸ“Š Availability Status</strong>
          <br>
          <small style="color: #666;">
            <% if (user.isAvailable) { %>
              You are currently accepting new client bookings
            <% } else { %>
              You are not accepting new client bookings
            <% } %>
          </small>
        </div>
        <form method="post" action="/coach/toggle-availability" style="margin: 0;">
          <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="checkbox" <%= user.isAvailable ? 'checked' : '' %> onchange="this.form.submit()" style="margin-right: 0.5rem;">
            <span style="font-weight: bold; color: <%= user.isAvailable ? '#28a745' : '#dc3545' %>;">
              <%= user.isAvailable ? 'Available' : 'Unavailable' %>
            </span>
          </label>
        </form>
      </div>
    </div>
    
    <% if (!calendarConnected) { %>
      <div style="background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem;">
        <strong>ğŸ“… Calendar not connected</strong><br>
        Connect your Google Calendar to manage availability and view upcoming events.
      </div>
      <a href="/coach/calendar/connect" class="btn" style="background: #007bff; color: white; padding: 0.5rem 1rem; text-decoration: none; border-radius: 4px; display: inline-block;">
        ğŸ”— Connect Google Calendar
      </a>
    <% } else { %>
      <div style="background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem;">
        <strong>âœ… Calendar connected</strong><br>
        Your Google Calendar is successfully connected and synced.
      </div>
    <% } %>
    <h4>Upcoming Meetings</h4>
    <% if (meetings && meetings.length) { %>
      <ul>
        <% meetings.forEach(m => { %>
          <li><%= m.start %> â€“ <%= m.summary %></li>
        <% }) %>
      </ul>
    <% } else { %>
      <p>No upcoming meetings.</p>
    <% } %>
  <% } else { %>
    <h3>Client Tools</h3>
    <% if (!calendarConnected) { %>
      <div style="background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem;">
        <strong>ğŸ“… Calendar not connected</strong><br>
        Connect your Google Calendar to automatically receive appointment invitations and reminders.
      </div>
      <a href="/client/calendar/connect" class="btn" style="background: #007bff; color: white; padding: 0.5rem 1rem; text-decoration: none; border-radius: 4px; display: inline-block; margin-bottom: 1rem;">
        ğŸ”— Connect Google Calendar
      </a>
    <% } else { %>
      <div style="background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem;">
        <strong>âœ… Calendar connected</strong><br>
        Your Google Calendar is successfully connected. You'll receive appointment invitations automatically.
      </div>
    <% } %>
    
    <h3>Schedule Your Hybrid Coaching Call</h3>
    <% if (slots && slots.length && availableCoaches && availableCoaches.length) { %>
      <form method="post" action="/schedule" style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
        <div style="margin-bottom: 1rem;">
          <label for="coach" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Choose your coach:</label>
          <select name="coachId" id="coach" required style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
            <option value="">Select a coach...</option>
            <% availableCoaches.forEach(coach => { %>
              <option value="<%= coach.id %>">
                <%= coach.coachName || coach.displayName %> 
                <% if (coach.coachLevel) { %>
                  - Level <%= coach.coachLevel %>
                <% } %>
              </option>
            <% }) %>
          </select>
        </div>
        
        <div style="margin-bottom: 1rem;">
          <label for="slot" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Choose a time slot:</label>
          <select name="slot" id="slot" required style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
            <option value="">Select a time...</option>
            <% slots.forEach(s => { %>
              <option value="<%= s.iso %>"><%= s.label %></option>
            <% }) %>
          </select>
        </div>
        
        <button type="submit" style="background: #007bff; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem;">
          ğŸ“… Book Appointment
        </button>
      </form>
    <% } else if (!availableCoaches || availableCoaches.length === 0) { %>
      <div style="background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem;">
        <strong>âš ï¸ No coaches available</strong><br>
        All coaches are currently unavailable for new bookings. Please check back later.
      </div>
    <% } else { %>
      <p>Click below to create a test room immediately:</p>
      <a href="/room/create" class="btn" style="background: #28a745; color: white; padding: 0.5rem 1rem; text-decoration: none; border-radius: 4px; display: inline-block;">Create Instant Room</a>
    <% } %>
  <% } %>

  <h3>
    Upcoming Appointments
    <% if (user.role === 'coach') { %>
      <span style="font-size: 0.8em; color: #666;">(Auto-refreshing every 10 seconds)</span>
    <% } %>
  </h3>
  <% if (appointments && appointments.length) { %>
    <ul style="list-style: none; padding: 0;">
      <% appointments.forEach(a => { %>
        <li class="appointment-item <%= user.role === 'coach' ? 'coach' : '' %>">
          <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div style="flex: 1;">
              <strong>ğŸ“… <%= new Date(a.scheduledFor).toLocaleString() %></strong>
              <% if (a.status === 'cancelled') { %>
                <span style="background: #dc3545; color: white; padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.8rem; margin-left: 0.5rem;">CANCELLED</span>
              <% } %>
              <% if (user.role === 'coach' && a.client) { %>
                <br>ğŸ‘¤ Client: <%= a.client.displayName || a.client.email %>
              <% } else if (user.role === 'client' && a.coach) { %>
                <br>ğŸ“ Coach: <%= a.coach.coachName || a.coach.displayName %> 
                <% if (a.coach.coachLevel) { %>
                  (Level <%= a.coach.coachLevel %>)
                <% } %>
              <% } %>
              <br>
              <span style="color: #666; font-size: 0.9em;">Room ID: <%= a.roomId.substring(0, 8) %>...</span>
            </div>
            
            <% if (a.status !== 'cancelled') { %>
              <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-left: 1rem;">
                <% if (user.role === 'coach') { %>
                  <form method="post" action="/coach/reassign-appointment" style="margin: 0;">
                    <input type="hidden" name="appointmentId" value="<%= a.id %>">
                    <button type="submit" style="background: #ffc107; color: #212529; padding: 0.3rem 0.6rem; border: none; border-radius: 3px; font-size: 0.8rem; cursor: pointer;" onclick="return confirm('Send this call back to the coach pool?')">
                      ğŸ”„ Return to Pool
                    </button>
                  </form>
                <% } else { %>
                  <form method="post" action="/client/cancel-appointment" style="margin: 0;">
                    <input type="hidden" name="appointmentId" value="<%= a.id %>">
                    <button type="submit" style="background: #dc3545; color: white; padding: 0.3rem 0.6rem; border: none; border-radius: 3px; font-size: 0.8rem; cursor: pointer;" onclick="return confirm('Cancel this appointment?')">
                      âŒ Cancel
                    </button>
                  </form>
                <% } %>
              </div>
            <% } %>
          </div>
          
          <% if (a.status !== 'cancelled') { %>
            <div style="margin-top: 0.5rem;">
              <a href="/room/<%= a.roomId %>" class="btn" style="background: #28a745; color: white; padding: 0.5rem 1rem; text-decoration: none; border-radius: 4px; display: inline-block;">âœ… Join Room</a>
            </div>
          <% } %>
        </li>
      <% }) %>
    </ul>
  <% } else { %>
    <p style="color: #666;">No upcoming appointments. 
      <% if (user.role === 'client') { %>
        Schedule one above or create an instant room.
      <% } else { %>
        Waiting for clients to book appointments...
      <% } %>
    </p>
  <% } %>

  <% if (user.role === 'coach') { %>
    <div style="margin-top:1rem">
      <a href="/room/create" class="btn" style="background: #17a2b8; color: white; padding: 0.5rem 1rem; text-decoration: none; border-radius: 4px;">ğŸ§ª Launch Test Room</a>
    </div>
  <% } %>

  <p style="margin-top:2rem"><a href="/auth/logout">Logout</a></p>
</section> 