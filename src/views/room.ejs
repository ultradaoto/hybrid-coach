<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= title %></title>
    <style>
      body {
        margin: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        background: #f9fafb;
        flex-direction: column;
      }
      #videoContainer{ display:flex; }
      #videoContainer.reverse{ flex-direction:row-reverse; }
      video {
        width: 45%;
        max-width: 480px;
        border: 2px solid #2d3748;
        margin: 0.5rem;
      }
      #messages { height:120px; overflow:auto; width:90%; margin-top:1rem; background:#fff; padding:0.5rem; border:1px solid #ccc; }
    </style>
  </head>
  <body>
    <h2>Hybrid Coaching Call</h2>
    <div id="videoContainer">
      <video id="localVideo" autoplay playsinline muted></video>
      <video id="remoteVideo" autoplay playsinline></video>
      <div style="display:flex; width:100%; justify-content:center;">
        <span id="localLabel" style="width:45%; text-align:center;"></span>
        <span id="remoteLabel" style="width:45%; text-align:center;"></span>
      </div>
    </div>
    <div id="messages"></div>
    <div style="margin-top:0.5rem; width:90%; display:flex;">
      <input id="msgInput" style="flex:1; padding:0.5rem" placeholder="Type a message to Hybrid AI..." />
      <button id="sendBtn">Send</button>
    </div>
    <div style="margin-top:0.5rem; font-weight:bold;" id="callTimer">00:00</div>

    <script src="/socket.io/socket.io.js"></script>

    <!-- Load mediasoup-client as an ES module and expose it globally -->
    <script type="module">
      import { Device } from 'https://cdn.jsdelivr.net/npm/mediasoup-client@4/dist/mediasoup-client.min.js';
      window.mediasoupClient = { Device };
    </script>

    <script>
      const roomId = "<%= roomId %>";
      const userRole = "<%= user.role %>";
      const userName = "<%= user.displayName || user.email %>";
      const jwtToken = "<%= jwt %>";
      const sessionId = "<%= sessionId %>";
      localStorage.setItem('jwt', jwtToken);
      const socket = io();
      const messages = document.getElementById('messages');

      function log(msg){ messages.innerHTML += msg + '<br>'; }

      socket.emit('join-room', { roomId, name: userName });

      let localStream;
      let sendTransport, recvTransport, device;
      const localVideo = document.getElementById('localVideo');
      const remoteVideo = document.getElementById('remoteVideo');

      document.getElementById('localLabel').innerText = userName + ' (You)';
      if(userRole === 'coach'){
        document.getElementById('videoContainer').classList.add('reverse');
      }

      /************* mediasoup SFU **************/
      const sfu = io({ path: '/mediasoup' });

      function once(ev){ return new Promise(res=> sfu.once(ev,res)); }

      async function makeTransport(kind) {
        return new Promise(res => {
          sfu.emit('sfu-create-transport', {}, async params => {
            const tp = kind === 'send'
              ? device.createSendTransport(params)
              : device.createRecvTransport(params);

            tp.on('connect', ({ dtlsParameters }, cb) =>
              sfu.emit('sfu-connect-transport',
                { id: tp.id, dtlsParameters }, cb));

            if (kind === 'send') {
              tp.on('produce', ({ kind, rtpParameters }, cb) =>
                sfu.emit('sfu-produce',
                  { transportId: tp.id, kind, rtpParameters },
                  ({ id, error }) => error ? console.error(error) : cb({ id })));
            }
            res(tp);
          });
        });
      }

      async function joinSFU(){
        console.log('ðŸ“¹ requesting camera');
        localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
        localVideo.srcObject = localStream;

        console.log('ðŸŽ¥ got local stream, connecting to SFU');
        device = new mediasoupClient.Device();
        sfu.emit('join-sfu',{roomId});
        const rtpCaps = await once('sfu-rtpCapabilities');
        console.log('ðŸ”§ loaded device');
        await device.load({routerRtpCapabilities:rtpCaps});

        sendTransport = await makeTransport('send');
        console.log('ðŸšš send transport ready', sendTransport.id);
        const camTrack = localStream.getVideoTracks()[0];
        await sendTransport.produce({track:camTrack});
        console.log('ðŸ“¡ produced local video');

        recvTransport = await makeTransport('recv');
        console.log('ðŸ“¥ recv transport ready', recvTransport.id);

        sfu.on('sfu-newProducer', ({ id, kind }) => {
          console.log('ðŸ†• new producer', id, kind);
          sfu.emit('sfu-consume',
            { transportId: recvTransport.id, producerId: id,
              rtpCapabilities: device.rtpCapabilities },
            async ({ id: cid, kind, rtpParameters, error }) => {
              if (error) { console.error(error); return; }
              const consumer = await recvTransport.consume({
                id: cid, producerId: id, kind, rtpParameters
              });
              const ms = new MediaStream([consumer.track]);
              remoteVideo.srcObject = ms;
            });
        });
      }

      joinSFU().then(aiGreeting);

      // AI greeting after media & SFU ready
      async function aiGreeting(){
        const greetingPrompt = `Say: Hello ${userName}. Welcome to the session! How are things going with Ultra so far?`;
        const res = await fetch('/api/chat', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ message: greetingPrompt, userId:'<%= user.id %>', sessionId }) });
        const data = await res.json();
        log('AI: '+data.reply);
        await logMessage('ai', data.reply);
        playTTS(data.reply);
      }

      // Chat with AI
      const inputEl = document.getElementById('msgInput');
      document.getElementById('sendBtn').onclick = async () => {
        const text = inputEl.value.trim();
        if(!text) return;
        log('You: ' + text);
        inputEl.value='';
        await logMessage('client', text);
        const res  = await fetch('/api/chat', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ message: text, userId: '<%= user.id %>', sessionId }) });
        const data = await res.json();
        log('AI: ' + data.reply);
        await logMessage('ai', data.reply);
        // enqueue TTS
        playTTS(data.reply);
      };

      // Call timer & 15-minute callback
      const timerEl = document.getElementById('callTimer');
      let originTs = null;
      socket.on('room-start', ts => { originTs = ts; });

      let fifteenFired = false;
      setInterval(async () => {
        if(originTs === null) return;
        const elapsed = Math.floor((Date.now() - originTs)/1000);
        const mm = String(Math.floor(elapsed/60)).padStart(2,'0');
        const ss = String(elapsed%60).padStart(2,'0');
        timerEl.textContent = `${mm}:${ss}`;

        if (!fifteenFired && elapsed >= 900){
          fifteenFired = true;
          const note = 'System: The coach has another call in 5 minutes and will step away soon. Please provide any final recommendations for the next week of Ultra use.';
          await logMessage('system', note);
          const res = await fetch('/api/chat', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ message: note, userId:'<%= user.id %>', sessionId }) });
          const data = await res.json();
          log('AI: '+data.reply);
          await logMessage('ai', data.reply);
          playTTS(data.reply);
        }
      },1000);
    </script>
  </body>
</html> 