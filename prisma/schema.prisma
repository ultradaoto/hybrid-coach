generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                         String                    @id @default(cuid())
  googleId                   String?                   @unique
  email                      String                    @unique
  displayName                String?
  role                       String                    @default("client")
  googleTokens               Json?
  isAvailable                Boolean                   @default(false)
  coachLevel                 Int?
  coachName                  String?
  lastSkoolSync              DateTime?
  membershipEndDate          DateTime?
  membershipWarningShown     Boolean                   @default(false)
  skoolUltraEmail            String?
  skoolVagusEmail            String?
  ultraSubscriptionStatus    String?
  vagusSubscriptionStatus    String?
  lastPhotoSync              DateTime?
  profilePhotoPath           String?
  skoolBio                   String?
  skoolJoinedDate            DateTime?
  skoolProfilePhotoUrl       String?
  skoolProfileUrl            String?
  accountDeletionRequestedAt DateTime?
  createdAt                  DateTime                  @default(now())
  dataRetentionConsent       Boolean                   @default(true)
  lastDataExportAt           DateTime?
  updatedAt                  DateTime                  @updatedAt
  appointmentsAsClient       Appointment[]             @relation("ClientAppointments")
  appointmentsAsCoach        Appointment[]             @relation("CoachAppointments")
  archivedTranscripts        ArchivedTranscript[]
  clientGoals                ClientGoal[]
  clientObservations         ClientObservation[]
  clientSummaries            ClientSummary[]
  dataDeletionRequests       DataDeletionRequest[]
  membershipHistory          MembershipStatusHistory[]
  messages                   Message[]
  profile                    Profile?
  sessions                   Session[]
  sessionInsights            SessionInsight[]

  @@index([role])
  @@index([vagusSubscriptionStatus])
  @@index([isAvailable])
  @@index([createdAt])
}

model Profile {
  id                      String    @id @default(cuid())
  userId                  String    @unique
  bioJson                 Json?
  challenges              String[]  @default([])
  clientFacts             String[]  @default([])
  contextNotes            String?
  lastSummary             String?
  preferences             Json?
  intakeCoachingGoals     String?
  intakeInitialMood       Int?
  intakeSymptoms          String?
  onboardingCompleted     Boolean   @default(false)
  onboardingCompletedAt   DateTime?
  accumulatedInsights     String?
  allowAnonymizedResearch Boolean   @default(false)
  allowDataAggregation    Boolean   @default(true)
  contextVersion          Int       @default(0)
  createdAt               DateTime  @default(now())
  lastContextUpdateAt     DateTime?
  updatedAt               DateTime  @updatedAt
  user                    User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([onboardingCompleted])
}

model Session {
  id              String          @id @default(cuid())
  roomId          String
  startedAt       DateTime        @default(now())
  endedAt         DateTime?
  userId          String
  summary         String?
  appointmentId   String?
  sessionType     String          @default("adhoc") // "adhoc" or "scheduled"
  aiSummary       String?
  durationMinutes Int             @default(20)
  status          String          @default("active")
  transcript      String?
  warningsSent    Int             @default(0)
  archivedAt      DateTime?
  isArchived      Boolean         @default(false)
  messages        Message[]
  appointment     Appointment?    @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  insight         SessionInsight?
  rating          SessionRating?

  @@index([userId, status])
  @@index([status, endedAt])
  @@index([isArchived])
  @@index([appointmentId])
  @@index([sessionType])
}

model SessionRating {
  id        String   @id @default(cuid())
  sessionId String   @unique
  rating    Int
  comment   String?
  tipAmount Float?
  createdAt DateTime @default(now())
  session   Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
}

model Message {
  id        String   @id @default(cuid())
  sessionId String
  sender    String
  content   String
  createdAt DateTime @default(now())
  userId    String?
  session   Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([sessionId, createdAt])
}

model SessionInsight {
  id                  String   @id @default(cuid())
  sessionId           String   @unique
  userId              String
  summary             String?
  keyTopics           Json?
  clientMoodStart     Int?
  clientMoodEnd       Int?
  breakthroughMoments String[] @default([])
  concernsFlagged     String[] @default([])
  clientCommitments   String[] @default([])
  suggestedFocusAreas String[] @default([])
  rawAnalysis         Json?
  modelVersion        String?
  generatedAt         DateTime @default(now())
  session             Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([generatedAt])
}

model ClientObservation {
  id                String    @id @default(cuid())
  userId            String
  observationType   String
  title             String?
  description       String
  relatedSessionIds String[]  @default([])
  confidenceScore   Float?
  humanVerified     Boolean   @default(false)
  humanVerifiedBy   String?
  humanVerifiedAt   DateTime?
  humanNotes        String?
  isActive          Boolean   @default(true)
  supersededBy      String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, observationType])
  @@index([userId, isActive])
  @@index([createdAt])
}

model ClientGoal {
  id              String    @id @default(cuid())
  userId          String
  goalText        String
  category        String?
  status          String    @default("active")
  progressNotes   Json?
  currentProgress Int?      @default(0)
  targetDate      DateTime?
  achievedAt      DateTime?
  source          String?
  sourceSessionId String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([userId, category])
}

model ClientSummary {
  id                 String   @id @default(cuid())
  userId             String
  periodType         String
  periodStart        DateTime
  periodEnd          DateTime
  sessionCount       Int      @default(0)
  totalDurationMins  Int      @default(0)
  averageMoodStart   Float?
  averageMoodEnd     Float?
  moodTrend          String?
  topTopics          String[] @default([])
  progressHighlights String[] @default([])
  concernsToMonitor  String[] @default([])
  goalsProgress      Json?
  includedSessionIds String[] @default([])
  generatedAt        DateTime @default(now())
  modelVersion       String?
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, periodType, periodStart])
  @@index([userId, periodType])
  @@index([periodEnd])
}

model ArchivedTranscript {
  id                String   @id @default(cuid())
  originalId        String
  sessionId         String
  userId            String
  archiveSummary    String?
  keyQuotes         Json?
  speakerBreakdown  Json?
  originalCreatedAt DateTime
  messageCount      Int      @default(0)
  archivedAt        DateTime @default(now())
  archiveReason     String?
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionId])
  @@index([archivedAt])
}

model DataDeletionRequest {
  id               String    @id @default(cuid())
  userId           String
  requestType      String
  requestedScope   Json?
  requestReason    String?
  status           String    @default("pending")
  processedAt      DateTime?
  processedBy      String?
  deletionLog      Json?
  errorLog         String?
  userConfirmed    Boolean   @default(false)
  confirmationCode String?   @unique
  confirmedAt      DateTime?
  createdAt        DateTime  @default(now())
  expiresAt        DateTime
  user             User      @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model Appointment {
  id           String    @id @default(cuid())
  scheduledFor DateTime
  durationMin  Int       @default(30)
  clientId     String
  coachId      String
  roomId       String    @unique
  status       String    @default("scheduled")
  cancelledAt  DateTime?
  cancelledBy  String?
  createdAt    DateTime  @default(now())
  client       User      @relation("ClientAppointments", fields: [clientId], references: [id], onDelete: Cascade)
  coach        User      @relation("CoachAppointments", fields: [coachId], references: [id], onDelete: Cascade)
  sessions     Session[]

  @@index([status, scheduledFor])
  @@index([clientId, scheduledFor])
  @@index([coachId, status])
}

model SkoolMonitoringLog {
  id               Int      @id @default(autoincrement())
  community        String
  membersFound     Int
  newMembers       Int
  cancelledMembers Int
  syncDurationMs   Int
  success          Boolean
  errorMessage     String?
  executedAt       DateTime @default(now())

  @@index([community, executedAt])
}

model MembershipStatusHistory {
  id               String   @id @default(cuid())
  userId           String
  community        String
  previousStatus   String?
  newStatus        String
  changeDetectedAt DateTime @default(now())
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, community])
}

model AuthCode {
  id                String        @id @default(cuid())
  code              String        @unique
  skoolUserId       String
  skoolUsername     String
  generatedAt       DateTime      @default(now())
  expiresAt         DateTime
  usedAt            DateTime?
  usedIpAddress     String?
  userAgent         String?
  deviceFingerprint String?
  isActive          Boolean       @default(true)
  userSessions      UserSession[]

  @@index([code])
  @@index([skoolUserId, generatedAt])
}

model UserSession {
  id                String   @id @default(cuid())
  sessionId         String   @unique
  skoolUserId       String
  skoolUsername     String
  authCodeUsed      String
  createdAt         DateTime @default(now())
  expiresAt         DateTime
  lastActive        DateTime @default(now())
  ipAddress         String?
  userAgent         String?
  deviceFingerprint String?
  isActive          Boolean  @default(true)
  authCode          AuthCode @relation(fields: [authCodeUsed], references: [code])

  @@index([sessionId])
  @@index([skoolUserId])
  @@index([expiresAt])
}

model RateLimit {
  id            String   @id @default(cuid())
  skoolUserId   String
  requestDate   DateTime @db.Date
  requestCount  Int      @default(1)
  lastRequestAt DateTime @default(now())

  @@unique([skoolUserId, requestDate])
  @@index([skoolUserId, requestDate])
}
