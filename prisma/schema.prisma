// ============================================
// MyUltra.Coach Database Schema v2.0
// Long-term Client Data Management
// ============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// CORE IDENTITY
// ============================================

model User {
  id                      String    @id @default(cuid())
  googleId                String?   @unique
  email                   String    @unique
  displayName             String?
  role                    String    @default("client") // coach, client, admin
  googleTokens            Json?
  
  // Coach-specific
  isAvailable             Boolean   @default(false)
  coachLevel              Int?
  coachName               String?
  
  // Skool Integration
  skoolUltraEmail         String?
  skoolVagusEmail         String?
  ultraSubscriptionStatus String?
  vagusSubscriptionStatus String?
  lastSkoolSync           DateTime?
  membershipEndDate       DateTime?
  membershipWarningShown  Boolean   @default(false)
  
  // Profile Photos
  skoolProfileUrl         String?
  skoolProfilePhotoUrl    String?
  profilePhotoPath        String?
  skoolBio                String?   @db.Text
  skoolJoinedDate         DateTime?
  lastPhotoSync           DateTime?
  
  // Data lifecycle
  dataRetentionConsent    Boolean   @default(true)
  lastDataExportAt        DateTime?
  accountDeletionRequestedAt DateTime?
  
  // Timestamps
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  
  // Relations
  profile                 Profile?
  appointmentsAsClient    Appointment[] @relation("ClientAppointments")
  appointmentsAsCoach     Appointment[] @relation("CoachAppointments")
  sessions                Session[]
  messages                Message[]
  membershipHistory       MembershipStatusHistory[]
  sessionInsights         SessionInsight[]
  clientObservations      ClientObservation[]
  clientGoals             ClientGoal[]
  clientSummaries         ClientSummary[]
  archivedTranscripts     ArchivedTranscript[]
  dataDeletionRequests    DataDeletionRequest[]
  
  @@index([role])
  @@index([vagusSubscriptionStatus])
  @@index([isAvailable])
  @@index([createdAt])
}

model Profile {
  id                      String    @id @default(cuid())
  userId                  String    @unique
  bioJson                 Json?
  
  // Client context (AI enhancement)
  clientFacts             String[]  @default([])
  challenges              String[]  @default([])
  preferences             Json?
  lastSummary             String?   @db.Text
  contextNotes            String?   @db.Text
  
  // Accumulated context for smart windows
  accumulatedInsights     String?   @db.Text
  lastContextUpdateAt     DateTime?
  contextVersion          Int       @default(0)
  
  // Onboarding
  onboardingCompleted     Boolean   @default(false)
  onboardingCompletedAt   DateTime?
  intakeCoachingGoals     String?   @db.Text
  intakeSymptoms          String?   @db.Text
  intakeInitialMood       Int?
  
  // Privacy settings
  allowDataAggregation    Boolean   @default(true)
  allowAnonymizedResearch Boolean   @default(false)
  
  // Timestamps
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  
  // Relations
  user                    User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([onboardingCompleted])
}

// ============================================
// SESSIONS & COMMUNICATION
// ============================================

model Session {
  id                String    @id @default(cuid())
  roomId            String
  appointmentId     String
  userId            String
  
  // Session timing
  startedAt         DateTime  @default(now())
  endedAt           DateTime?
  durationMinutes   Int       @default(20)
  
  // Session state
  status            String    @default("active") // active, completed, cancelled
  warningsSent      Int       @default(0)
  
  // Content
  transcript        String?   @db.Text
  aiSummary         String?   @db.Text
  summary           String?   @db.Text
  
  // Archival
  isArchived        Boolean   @default(false)
  archivedAt        DateTime?
  
  // Relations
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  appointment       Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  messages          Message[]
  rating            SessionRating?
  insight           SessionInsight?
  
  @@unique([appointmentId, userId])
  @@index([userId, status])
  @@index([status, endedAt])
  @@index([isArchived])
}

model SessionRating {
  id          String    @id @default(cuid())
  sessionId   String    @unique
  rating      Int       // 1-5
  comment     String?   @db.Text
  tipAmount   Float?
  createdAt   DateTime  @default(now())
  
  session     Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
}

model Message {
  id          String    @id @default(cuid())
  sessionId   String
  userId      String
  sender      String    // client, coach, ai
  content     String    @db.Text
  createdAt   DateTime  @default(now())
  
  session     Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([sessionId, createdAt])
}

// ============================================
// LONG-TERM CLIENT DATA
// ============================================

model SessionInsight {
  id                  String    @id @default(cuid())
  sessionId           String    @unique
  userId              String
  
  // Structured insights
  summary             String?   @db.Text
  keyTopics           Json?     // String[]
  clientMoodStart     Int?      // 1-5
  clientMoodEnd       Int?      // 1-5
  breakthroughMoments String[]  @default([])
  concernsFlagged     String[]  @default([])
  
  // Action items
  clientCommitments   String[]  @default([])
  suggestedFocusAreas String[]  @default([])
  
  // Raw AI output
  rawAnalysis         Json?
  modelVersion        String?
  
  generatedAt         DateTime  @default(now())
  
  session             Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([generatedAt])
}

model ClientObservation {
  id                String    @id @default(cuid())
  userId            String
  
  // Observation details
  observationType   String    // pattern, progress, concern, milestone, breakthrough
  title             String?
  description       String    @db.Text
  
  // Evidence
  relatedSessionIds String[]  @default([])
  confidenceScore   Float?    @db.DoublePrecision
  
  // Human verification
  humanVerified     Boolean   @default(false)
  humanVerifiedBy   String?
  humanVerifiedAt   DateTime?
  humanNotes        String?   @db.Text
  
  // Lifecycle
  isActive          Boolean   @default(true)
  supersededBy      String?
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, observationType])
  @@index([userId, isActive])
  @@index([createdAt])
}

model ClientGoal {
  id              String    @id @default(cuid())
  userId          String
  
  // Goal definition
  goalText        String    @db.Text
  category        String?   // health, wellness, energy, sleep, stress, breathing
  status          String    @default("active") // active, achieved, paused, abandoned
  
  // Progress
  progressNotes   Json?     // [{date, note, progressPct}]
  currentProgress Int?      @default(0)
  targetDate      DateTime?
  achievedAt      DateTime?
  
  // Source
  source          String?   // onboarding, session, client_input, coach_suggested
  sourceSessionId String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, status])
  @@index([userId, category])
}

model ClientSummary {
  id                  String    @id @default(cuid())
  userId              String
  
  // Period
  periodType          String    // weekly, monthly, quarterly
  periodStart         DateTime
  periodEnd           DateTime
  
  // Metrics
  sessionCount        Int       @default(0)
  totalDurationMins   Int       @default(0)
  averageMoodStart    Float?    @db.DoublePrecision
  averageMoodEnd      Float?    @db.DoublePrecision
  moodTrend           String?   // improving, stable, declining
  
  // AI themes
  topTopics           String[]  @default([])
  progressHighlights  String[]  @default([])
  concernsToMonitor   String[]  @default([])
  
  // Goals snapshot
  goalsProgress       Json?
  includedSessionIds  String[]  @default([])
  
  generatedAt         DateTime  @default(now())
  modelVersion        String?
  
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, periodType, periodStart])
  @@index([userId, periodType])
  @@index([periodEnd])
}

// ============================================
// ARCHIVAL & DATA LIFECYCLE
// ============================================

model ArchivedTranscript {
  id                String    @id @default(cuid())
  originalId        String
  sessionId         String
  userId            String
  
  // Archived content
  archiveSummary    String?   @db.Text
  keyQuotes         Json?     // [{text, context, timestamp}]
  speakerBreakdown  Json?     // {client: n, ai: n, coach: n}
  
  // Original metadata
  originalCreatedAt DateTime
  messageCount      Int       @default(0)
  
  // Archive metadata
  archivedAt        DateTime  @default(now())
  archiveReason     String?   // age, storage_optimization, user_request
  
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([sessionId])
  @@index([archivedAt])
}

model DataDeletionRequest {
  id                String    @id @default(cuid())
  userId            String
  
  // Request details
  requestType       String    // full_deletion, partial_deletion, data_export
  requestedScope    Json?
  requestReason     String?   @db.Text
  
  // Status
  status            String    @default("pending") // pending, processing, completed, failed
  processedAt       DateTime?
  processedBy       String?
  
  // Audit
  deletionLog       Json?     // {table: rowsDeleted}
  errorLog          String?   @db.Text
  
  // Verification
  userConfirmed     Boolean   @default(false)
  confirmationCode  String?   @unique
  confirmedAt       DateTime?
  
  createdAt         DateTime  @default(now())
  expiresAt         DateTime
  
  user              User      @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// SCHEDULING
// ============================================

model Appointment {
  id            String    @id @default(cuid())
  scheduledFor  DateTime
  durationMin   Int       @default(30)
  clientId      String
  coachId       String
  roomId        String    @unique
  status        String    @default("scheduled") // scheduled, active, completed, cancelled
  cancelledAt   DateTime?
  cancelledBy   String?
  createdAt     DateTime  @default(now())
  
  client        User      @relation("ClientAppointments", fields: [clientId], references: [id], onDelete: Cascade)
  coach         User      @relation("CoachAppointments", fields: [coachId], references: [id], onDelete: Cascade)
  sessions      Session[]
  
  @@index([status, scheduledFor])
  @@index([clientId, scheduledFor])
  @@index([coachId, status])
}

// ============================================
// SKOOL INTEGRATION & AUTH
// ============================================

model SkoolMonitoringLog {
  id              Int       @id @default(autoincrement())
  community       String    // ultra, vagus
  membersFound    Int
  newMembers      Int
  cancelledMembers Int
  syncDurationMs  Int
  success         Boolean
  errorMessage    String?   @db.Text
  executedAt      DateTime  @default(now())
  
  @@index([community, executedAt])
}

model MembershipStatusHistory {
  id                String    @id @default(cuid())
  userId            String
  community         String    // ultra, vagus
  previousStatus    String?
  newStatus         String
  changeDetectedAt  DateTime  @default(now())
  
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, community])
}

model AuthCode {
  id                String    @id @default(cuid())
  code              String    @unique
  skoolUserId       String
  skoolUsername     String
  generatedAt       DateTime  @default(now())
  expiresAt         DateTime
  usedAt            DateTime?
  usedIpAddress     String?
  userAgent         String?
  deviceFingerprint String?
  isActive          Boolean   @default(true)
  
  userSessions      UserSession[]
  
  @@index([code])
  @@index([skoolUserId, generatedAt])
}

model UserSession {
  id                String    @id @default(cuid())
  sessionId         String    @unique
  skoolUserId       String
  skoolUsername     String
  authCodeUsed      String
  createdAt         DateTime  @default(now())
  expiresAt         DateTime
  lastActive        DateTime  @default(now())
  ipAddress         String?
  userAgent         String?
  deviceFingerprint String?
  isActive          Boolean   @default(true)
  
  authCode          AuthCode  @relation(fields: [authCodeUsed], references: [code])
  
  @@index([sessionId])
  @@index([skoolUserId])
  @@index([expiresAt])
}

model RateLimit {
  id            String    @id @default(cuid())
  skoolUserId   String
  requestDate   DateTime  @db.Date
  requestCount  Int       @default(1)
  lastRequestAt DateTime  @default(now())
  
  @@unique([skoolUserId, requestDate])
  @@index([skoolUserId, requestDate])
}
