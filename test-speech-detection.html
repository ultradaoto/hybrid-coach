<!DOCTYPE html>
<html>
<head>
    <title>Speech Detection Test</title>
</head>
<body>
    <h1>Speech Detection Test</h1>
    <button id="start">Start Audio Detection</button>
    <div id="log" style="white-space: pre-wrap; border: 1px solid #ccc; padding: 10px; margin-top: 10px; height: 400px; overflow-y: auto;"></div>

    <script>
        const log = document.getElementById('log');
        let isAudioEnabled = true;
        let isAISpeaking = false;
        let isAIPaused = false;
        
        function addLog(msg) {
            log.textContent += new Date().toISOString() + ' - ' + msg + '\n';
            log.scrollTop = log.scrollHeight;
        }
        
        document.getElementById('start').onclick = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                addLog('‚úÖ Microphone access granted');
                
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const analyser = audioContext.createAnalyser();
                const microphone = audioContext.createMediaStreamSource(stream);
                const dataArray = new Uint8Array(analyser.frequencyBinCount);
                
                microphone.connect(analyser);
                analyser.fftSize = 256;
                
                let isSpeaking = false;
                let silenceTimer = null;
                let lastSpeechTime = 0;
                const SILENCE_THRESHOLD = 1000; // 1 second of silence
                const SPEECH_COOLDOWN = 2000; // 2 seconds cooldown
                
                function detectSpeaking() {
                    analyser.getByteFrequencyData(dataArray);
                    const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
                    
                    if (average > 10 && isAudioEnabled && !isAIPaused && !isAISpeaking) {
                        // Clear silence timer if speaking
                        if (silenceTimer) {
                            clearTimeout(silenceTimer);
                            silenceTimer = null;
                        }
                        
                        // Only trigger if not already speaking and cooldown passed
                        if (!isSpeaking && Date.now() - lastSpeechTime > SPEECH_COOLDOWN) {
                            isSpeaking = true;
                            addLog(`üé§ Client started speaking - Volume: ${average.toFixed(1)}`);
                        }
                    } else if (isSpeaking && !silenceTimer) {
                        // Start silence timer when speech stops
                        silenceTimer = setTimeout(() => {
                            isSpeaking = false;
                            lastSpeechTime = Date.now();
                            addLog('üîá Client stopped speaking');
                        }, SILENCE_THRESHOLD);
                    }
                    
                    requestAnimationFrame(detectSpeaking);
                }
                
                detectSpeaking();
                addLog('üéß Audio detection started - speak to test!');
                
            } catch (error) {
                addLog('‚ùå Error accessing microphone: ' + error.message);
            }
        };
    </script>
</body>
</html>